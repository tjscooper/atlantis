# =============================================================================
# nginx.conf — mounted into the frontend container
# =============================================================================
# Two jobs:
#   1. Serve the React static build (index.html + bundled JS/CSS)
#   2. Proxy /api/* requests to the FastAPI backend
#
# The browser only ever talks to this Nginx instance on port 80 (mapped to
# 3000 on the host). It has no idea the API is a separate container.
# =============================================================================

server {
    listen 80;
    server_name localhost;

    # ---------------------------------------------------------------------------
    # Static files
    # ---------------------------------------------------------------------------
    # The React build output (from `npm run build`) is copied into
    # /usr/share/nginx/html during the Docker multi-stage build.
    # ---------------------------------------------------------------------------
    root /usr/share/nginx/html;
    index index.html;

    # ---------------------------------------------------------------------------
    # API proxy
    # ---------------------------------------------------------------------------
    # Any request starting with /api/ gets forwarded to the FastAPI container.
    # The trailing slash and $request_uri combination strips the /api prefix
    # so FastAPI sees clean routes (e.g., /api/candidates -> /candidates).
    #
    # proxy_set_header blocks pass through the original client info so the
    # API can log real IPs and handle Host-based routing if needed.
    # ---------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://api:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Increase timeout for long-running prediction requests
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
    }

    # ---------------------------------------------------------------------------
    # MLflow proxy (optional — exposes MLflow UI through the same origin)
    # ---------------------------------------------------------------------------
    # If you want researchers to access MLflow dashboards without knowing
    # its internal port, proxy it here. Comment out if not needed.
    # ---------------------------------------------------------------------------
    location /mlflow/ {
        proxy_pass http://mlflow:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ---------------------------------------------------------------------------
    # SPA fallback
    # ---------------------------------------------------------------------------
    # React Router handles client-side routing. Any URL that doesn't match
    # a static file or the /api/ proxy needs to return index.html so React
    # can handle the route on the client side.
    # ---------------------------------------------------------------------------
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ---------------------------------------------------------------------------
    # Health check endpoint (used by Docker healthcheck on the frontend)
    # ---------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }
}
